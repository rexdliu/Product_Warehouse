# 功能测试指南

本指南将帮助你测试新实现的登录、注册和设置保存功能。

## 目录
1. [准备工作](#准备工作)
2. [测试用户注册](#测试用户注册)
3. [测试用户登录](#测试用户登录)
4. [测试设置保存](#测试设置保存)
5. [验证数据库持久化](#验证数据库持久化)
6. [问题排查](#问题排查)

---

## 准备工作

### 1. 启动后端服务

```bash
# 在项目根目录执行
bash start_backend.sh
```

等待后端启动成功，你应该看到类似的输出：
```
INFO:     Uvicorn running on http://127.0.0.1:8001
INFO:     Application startup complete.
```

### 2. 启动前端服务

在另一个终端中：
```bash
# 在项目根目录执行
npm run dev
```

访问 http://localhost:8003

### 3. 检查后端健康状态

```bash
curl http://127.0.0.1:8001/health
```

应该返回：
```json
{"status":"healthy"}
```

---

## 测试用户注册

### 步骤 1：访问注册页面

1. 打开浏览器访问 http://localhost:8003
2. 如果已登录，先登出（右上角）
3. 在登录页面点击 **Register** 标签

### 步骤 2：填写注册信息

填写以下测试信息：
- **Username**: testuser123
- **Email**: test@example.com
- **Phone**: 13800138000
- **Full Name**: Test User (可选)
- **Password**: Test123!
- **Confirm Password**: Test123!

### 步骤 3：提交注册

1. 点击 **Create Account** 按钮
2. 应该看到加载动画（"Creating account..."）
3. 注册成功后会自动登录并跳转到首页

### 预期结果

✅ 成功场景：
- 注册成功，自动登录
- 跳转到仪表板首页
- 右上角显示用户名

❌ 失败场景（应该看到错误提示）：
- 用户名已存在：显示 "The user with this username already exists"
- 邮箱已存在：显示 "The user with this email already exists"
- 手机号已存在：显示 "The user with this phone number already exists"
- 密码不匹配：显示 "Passwords do not match"
- 密码太短：显示 "Password must be at least 6 characters long"

### 验证注册

使用API测试脚本验证用户是否在数据库中：
```bash
python3 test_api.py
```

查看输出中的"用户注册测试"部分。

---

## 测试用户登录

### 步骤 1：登出当前用户

如果已登录，点击右上角的用户菜单，选择 "Logout"

### 步骤 2：使用新账户登录

1. 在登录页面输入：
   - **Username**: testuser123
   - **Password**: Test123!
2. 点击 **Sign In** 按钮

### 步骤 3：验证登录

登录成功后：
- 自动跳转到仪表板
- 右上角显示用户信息
- localStorage 中应该有 `access_token`（打开浏览器开发者工具 → Application → Local Storage）

### 测试错误处理

尝试以下错误场景：

1. **错误的用户名**
   - Username: wronguser
   - Password: Test123!
   - 应该看到：`Login failed...Incorrect username or password`

2. **错误的密码**
   - Username: testuser123
   - Password: wrongpassword
   - 应该看到：`Login failed...Incorrect username or password`

---

## 测试设置保存

### 步骤 1：访问设置页面

1. 登录后，点击左侧边栏的 **设置** 图标
2. 或直接访问 http://localhost:8003/settings

### 步骤 2：修改个人资料

在 **个人资料** 标签下：
1. 修改姓名（虽然不会保存，因为后端没有full_name更新端点）
2. 上传新头像（会保存）

### 步骤 3：修改仓库配置

在 **仓库** 标签下：
1. 修改仓库名称
2. 调整低库存阈值滑块（例如：从20%改到30%）

### 步骤 4：修改AI助手设置

在 **AI助手** 标签下：
1. 切换 "启用AI助手"
2. 切换 "自动建议"
3. 更改 "上下文记忆" 选项
4. 更改 "响应速度" 选项

### 步骤 5：修改通知设置

在 **通知** 标签下：
1. 切换各种通知渠道（邮箱、推送、短信）
2. 切换通知类型（低库存告警、订单更新等）

### 步骤 6：修改外观设置

在 **外观** 标签下：
1. 切换主题（浅色/深色/跟随系统）
2. 观察页面主题即时变化
3. 切换界面选项（显示动效、紧凑侧边栏等）

### 步骤 7：保存设置

1. 点击页面底部的 **保存更改** 按钮
2. 应该看到：
   - 按钮显示 "保存中..." 和加载动画
   - 保存成功后显示 Toast 提示：**"✅ 设置已成功保存到数据库"**
3. 检查浏览器控制台（F12），不应该有错误

### 预期结果

✅ 成功场景：
- 显示 "✅ 设置已成功保存到数据库"
- 设置立即生效（例如主题切换）

❌ 失败场景：
- 显示错误提示："❌ 保存失败: [错误信息]"
- 检查后端日志查看具体错误

---

## 验证数据库持久化

### 方法 1：刷新页面测试

1. 在设置页面修改一些设置并保存
2. **刷新浏览器页面（F5）**
3. 检查设置是否保持你刚才修改的值

✅ **如果设置保持不变**：说明数据已成功保存到数据库并加载

❌ **如果设置恢复到初始值**：说明数据没有正确保存或加载

### 方法 2：登出重新登录测试

1. 修改设置并保存
2. 登出账户
3. 重新登录
4. 进入设置页面
5. 检查设置是否保持

### 方法 3：使用API直接查询

```bash
# 首先登录获取token
curl -X POST "http://127.0.0.1:8001/api/v1/auth/login" \
  -F "username=testuser123" \
  -F "password=Test123!"

# 复制返回的access_token

# 查询用户设置
curl -X GET "http://127.0.0.1:8001/api/v1/users/settings" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN_HERE"
```

应该返回类似：
```json
{
  "theme": "dark",
  "notifications": {
    "email": true,
    "push": false,
    "sms": false,
    "lowStock": true,
    "orderUpdates": true,
    "systemAlerts": true
  },
  "ai_settings": {
    "enabled": true,
    "autoSuggestions": false,
    "voiceInput": false,
    "contextMemory": "persistent",
    "responseSpeed": "fast"
  },
  "avatar_url": null
}
```

### 方法 4：直接查询数据库（如果有权限）

```bash
# 使用MySQL客户端连接
mysql -h rm-gs54780452unf94747o.mysql.singapore.rds.aliyuncs.com \
  -u rex -p product_warehouse

# 输入密码后执行
SELECT id, username, theme, notifications, ai_settings
FROM users
WHERE username='testuser123';
```

---

## 功能清单

### ✅ 已实现功能

- [x] **用户注册**
  - [x] 用户名、邮箱、手机号唯一性验证
  - [x] 密码长度验证
  - [x] 密码匹配验证
  - [x] 自动登录

- [x] **用户登录**
  - [x] JWT令牌生成和保存
  - [x] 错误处理和提示
  - [x] 自动跳转到首页
  - [x] 登录状态持久化

- [x] **设置保存**
  - [x] 主题设置保存和加载
  - [x] 通知偏好保存和加载
  - [x] AI助手配置保存和加载
  - [x] 头像URL保存和加载
  - [x] 刷新页面后设置保持
  - [x] 登出重新登录后设置保持
  - [x] 保存成功/失败提示

- [x] **用户界面**
  - [x] 登录/注册标签切换
  - [x] 加载状态显示
  - [x] 错误提示显示
  - [x] 表单验证
  - [x] 禁用状态管理

### ⚠️ 已知限制

- **个人资料编辑**：姓名、邮箱、电话修改未连接后端（后端API需要单独实现）
- **头像上传**：只保存base64字符串，没有上传到服务器存储
- **密码修改**：UI已存在但未连接（后端API `/api/v1/users/me/password` 已实现）

---

## 问题排查

### 问题 1：登录/注册时显示网络错误

**症状**：
- `Request failed (0): Failed to fetch`
- 或 `Request failed (500): ...`

**解决方法**：
1. 检查后端是否正在运行：
   ```bash
   curl http://127.0.0.1:8001/health
   ```
2. 检查浏览器控制台（F12 → Network 标签）查看请求详情
3. 检查后端日志查看错误信息

### 问题 2：设置保存后刷新页面恢复初始值

**症状**：
- 显示"保存成功"但刷新后设置恢复

**可能原因**：
1. 后端没有正确保存到数据库
2. 前端加载设置时失败

**解决方法**：
1. 打开浏览器控制台，查看是否有错误
2. 使用API直接查询设置（见上方"方法3"）
3. 检查后端日志

### 问题 3：登录后显示401错误

**症状**：
- 访问受保护的API时返回401 Unauthorized

**解决方法**：
1. 检查localStorage中是否有access_token
2. 尝试重新登录
3. 检查token是否过期（默认10分钟）

### 问题 4：注册时显示"用户已存在"

**症状**：
- 使用新用户名仍然显示已存在

**解决方法**：
1. 尝试使用完全不同的用户名、邮箱和手机号
2. 检查数据库中是否有残留的测试数据
3. 清理数据库后重试

### 查看后端日志

后端日志会显示详细的错误信息：
```bash
# 在运行 start_backend.sh 的终端中查看实时日志
```

### 查看前端控制台

浏览器开发者工具（F12）：
- **Console**：查看JavaScript错误
- **Network**：查看API请求和响应
- **Application → Local Storage**：查看存储的token

---

## 测试检查清单

### 基本功能测试

- [ ] 能够成功注册新用户
- [ ] 能够使用注册的用户登录
- [ ] 登录后能够看到用户信息
- [ ] 能够修改设置并保存
- [ ] 刷新页面后设置保持
- [ ] 登出后重新登录设置保持
- [ ] 错误场景有正确的错误提示

### 数据持久化测试

- [ ] 主题设置保存到数据库
- [ ] 通知设置保存到数据库
- [ ] AI设置保存到数据库
- [ ] 头像URL保存到数据库
- [ ] 设置在页面刷新后加载
- [ ] 设置在重新登录后加载

### 用户体验测试

- [ ] 加载状态正确显示
- [ ] 按钮在加载时被禁用
- [ ] 成功/失败消息清晰显示
- [ ] 表单验证及时准确
- [ ] 页面导航流畅

---

## 快速测试流程

如果时间有限，可以按照这个快速流程测试核心功能：

### 5分钟快速测试

1. **注册新用户** (1分钟)
   - 填写注册表单
   - 提交并自动登录

2. **修改设置** (2分钟)
   - 切换主题到"深色"
   - 关闭"AI自动建议"
   - 点击保存

3. **验证持久化** (2分钟)
   - 刷新页面 → 检查主题仍为深色
   - 检查AI自动建议仍为关闭
   - 登出
   - 重新登录
   - 进入设置页面
   - 确认设置保持

如果以上3步都成功，说明核心功能正常工作！

---

## 下一步

完成测试后，你可以：

1. **报告问题**：如果发现bug，请记录详细的复现步骤
2. **实现更多功能**：
   - 完善个人资料编辑
   - 实现密码修改
   - 实现头像上传到服务器
   - 实现刷新令牌
3. **性能优化**：优化API调用和加载速度
4. **部署到生产环境**：参考 ECS_DEPLOYMENT.md

---

## 总结

通过本指南，你应该能够：
- ✅ 测试用户注册和登录功能
- ✅ 测试设置保存和加载功能
- ✅ 验证数据持久化到数据库
- ✅ 排查常见问题

如果所有测试都通过，恭喜！前后端已经成功连接，数据可以正确保存到数据库了。 🎉
