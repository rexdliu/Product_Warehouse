m;# 数据库设计规范

## 1. 概述

本文档定义了 Product Warehouse 项目的数据库设计规范，旨在确保数据库结构的一致性、可维护性和可扩展性。本项目使用 SQLAlchemy ORM 实现数据模型，并支持 SQLite 数据库（可轻松扩展到其他数据库），集成 Alembic 进行数据库迁移管理。

## 2. 技术栈

- **ORM**: SQLAlchemy
- **数据库**: SQLite (默认) / PostgreSQL (可选)
- **迁移工具**: Alembic
- **模型验证**: Pydantic

## 3. 命名规范

### 3.1 表名规范
- 使用小写字母
- 多个单词之间使用下划线分隔
- 使用复数形式表示实体集合
- 示例: `users`, `products`, `inventory_items`

### 3.2 字段名规范
- 使用小写字母
- 多个单词之间使用下划线分隔
- 字段名应具有描述性，能够清晰表达其含义
- 示例: `user_id`, `created_at`, `product_name`

### 3.3 索引命名规范
- 格式: `idx_{表名}_{字段名}`
- 复合索引: `idx_{表名}_{字段1}_{字段2}`
- 示例: `idx_users_email`, `idx_products_name_category`

### 3.4 外键命名规范
- 格式: `fk_{表名}_{字段名}_{引用表名}`
- 示例: `fk_orders_user_id_users`

## 4. 数据类型规范

### 4.1 常用数据类型映射

| 业务类型 | SQLAlchemy 类型 | 说明 |
|---------|----------------|------|
| 主键ID | `Integer` | 自增主键 |
| 字符串 | `String(length)` | 根据实际长度指定 |
| 长文本 | `Text` | 无长度限制的文本 |
| 布尔值 | `Boolean` | True/False 值 |
| 整数 | `Integer` | 整数值 |
| 浮点数 | `Float` | 浮点数值 |
| 日期时间 | `DateTime` | 完整时间戳 |
| 日期 | `Date` | 仅日期 |
| 时间 | `Time` | 仅时间 |
| JSON | `JSON` | JSON 格式数据 |

### 4.2 特殊字段规范

1. **主键字段**
   - 字段名: `id`
   - 类型: `Integer`
   - 约束: `primary_key=True`
   - 自动生成: `autoincrement=True`

2. **时间戳字段**
   - 创建时间: `created_at`
   - 更新时间: `updated_at`
   - 类型: `DateTime`
   - 默认值: `server_default=func.now()`

## 5. 模型设计规范

### 5.1 模型基类

所有模型应继承自统一的基类，包含通用字段和方法：

```python
from sqlalchemy import Column, Integer, DateTime
from sqlalchemy.sql import func
from app.core.database import Base

class BaseModel(Base):
    __abstract__ = True
    
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

### 5.2 模型定义示例

```python
from sqlalchemy import Column, Integer, String, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from app.models.base import BaseModel

class User(BaseModel):
    __tablename__ = "users"
    
    username = Column(String, unique=True, index=True, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)
    
    # 关系定义
    orders = relationship("Order", back_populates="user")
```

## 6. 关系设计规范

### 6.1 一对一关系
```python
# 主表
profile = relationship("UserProfile", uselist=False, back_populates="user")

# 从表
user_id = Column(Integer, ForeignKey("users.id"))
user = relationship("User", back_populates="profile")
```

### 6.2 一对多关系
```python
# 一的一方
orders = relationship("Order", back_populates="user")

# 多的一方
user_id = Column(Integer, ForeignKey("users.id"))
user = relationship("User", back_populates="orders")
```

### 6.3 多对多关系
```python
# 关联表
from sqlalchemy import Table

user_roles = Table(
    "user_roles",
    Base.metadata,
    Column("user_id", Integer, ForeignKey("users.id")),
    Column("role_id", Integer, ForeignKey("roles.id"))
)

# 模型中使用
roles = relationship("Role", secondary=user_roles, back_populates="users")
```

## 7. 索引和约束规范

### 7.1 索引定义
```python
# 单字段索引
email = Column(String, index=True)

# 复合索引
__table_args__ = (
    Index("idx_users_email_username", "email", "username"),
)
```

### 7.2 约束定义
```python
# 唯一约束
email = Column(String, unique=True)

# 检查约束
age = Column(Integer, CheckConstraint("age >= 0"))
```

## 8. 数据库迁移规范

### 8.1 迁移文件命名
- 格式: `{版本号}_{描述}.py`
- 示例: `20230101120000_create_users_table.py`

### 8.2 迁移操作
1. 生成迁移文件:
   ```bash
   alembic revision --autogenerate -m "描述"
   ```

2. 应用迁移:
   ```bash
   alembic upgrade head
   ```

3. 回滚迁移:
   ```bash
   alembic downgrade -1
   ```

## 9. CRUD 操作规范

### 9.1 基础 CRUD 类
```python
from sqlalchemy.orm import Session
from app.models.base import BaseModel

class CRUDBase:
    def __init__(self, model):
        self.model = model
        
    def get(self, db: Session, id: int):
        return db.query(self.model).filter(self.model.id == id).first()
        
    def get_multi(self, db: Session, skip: int = 0, limit: int = 100):
        return db.query(self.model).offset(skip).limit(limit).all()
        
    def create(self, db: Session, obj_in):
        db_obj = self.model(**obj_in.dict())
        db.add(db_obj)
        db.commit()
        db.refresh(db_obj)
        return db_obj
        
    def update(self, db: Session, db_obj, obj_in):
        obj_data = obj_in.dict(exclude_unset=True)
        for field, value in obj_data.items():
            setattr(db_obj, field, value)
        db.add(db_obj)
        db.commit()
        db.refresh(db_obj)
        return db_obj
        
    def remove(self, db: Session, id: int):
        obj = db.query(self.model).get(id)
        db.delete(obj)
        db.commit()
        return obj
```

## 10. 安全规范

### 10.1 敏感信息处理
- 密码应使用哈希存储，不应明文保存
- 个人身份信息应进行加密处理
- API 密钥等敏感信息应使用环境变量配置

### 10.2 SQL 注入防护
- 使用 SQLAlchemy ORM 而非原生 SQL
- 如需使用原生 SQL，应使用参数化查询

## 11. 性能优化规范

### 11.1 查询优化
- 合理使用索引
- 避免 N+1 查询问题
- 使用懒加载和急加载策略

### 11.2 分页处理
- 大量数据查询应实现分页
- 使用 `offset` 和 `limit` 控制返回数据量

## 12. 备份与恢复

### 12.1 备份策略
- 定期备份数据库
- 保留多个时间点的备份
- 测试备份数据的完整性

### 12.2 恢复流程
- 制定明确的数据恢复流程
- 定期演练恢复过程
- 记录恢复操作日志